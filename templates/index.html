<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Smart Irrigation System</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@2.0.1"></script>
<!-- ‚úÖ Chart.js (MUST COME FIRST) -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<!-- Icons -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>

<style>
/* ================= ROOT COLORS ================= */
:root {
  --bg-light: linear-gradient(135deg, #d4fc79, #96e6a1);
  --bg-dark: linear-gradient(135deg, #0f2027, #203a43, #2c5364);

  --glass-light: rgba(255,255,255,0.45);
  --glass-dark: rgba(20,20,20,0.65);

  --text-light: #1c1c1e;
  --text-dark: #f2f2f7;

  --green: #34c759;
  --red: #ff3b30;
  --blue: #007aff;
}

/* ================= BASE ================= */
body {
  margin: 0;
  font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto;
  background: var(--bg-light);
  color: var(--text-light);
  transition: all 0.5s ease;
  min-height: 100vh;
}

body.dark {
  background: var(--bg-dark);
  color: var(--text-dark);
}

/* ================= CONTAINER ================= */
.container {
  max-width: 1050px;
  margin: 30px auto;
  padding: 30px;
  border-radius: 26px;
  background: var(--glass-light);
  backdrop-filter: blur(22px);
  box-shadow: 0 40px 80px rgba(0,0,0,0.25);
  animation: slideFade 0.9s ease;
}

body.dark .container {
  background: var(--glass-dark);
}

/* Entrance animation */
@keyframes slideFade {
  from { opacity: 0; transform: translateY(40px) scale(0.96); }
  to { opacity: 1; transform: translateY(0) scale(1); }
}

/* ================= HEADINGS ================= */
h1 {
  text-align: center;
  font-weight: 700;
  letter-spacing: -0.5px;
}

.subtitle {
  text-align: center;
  opacity: 0.85;
  margin-bottom: 25px;
}

/* ================= DARK MODE TOGGLE ================= */
.toggle {
  display: flex;
  justify-content: center;
  margin-bottom: 25px;
}

.switch {
  position: relative;
  width: 62px;
  height: 34px;
}

.switch input { display: none; }

.slider {
  position: absolute;
  inset: 0;
  background: #ccc;
  border-radius: 999px;
  cursor: pointer;
  transition: 0.4s;
}

.slider:before {
  content: "";
  position: absolute;
  height: 26px;
  width: 26px;
  left: 4px;
  bottom: 4px;
  background: white;
  border-radius: 50%;
  transition: 0.4s;
}

input:checked + .slider {
  background: var(--green);
}

input:checked + .slider:before {
  transform: translateX(28px);
}

/* ================= FORM ================= */
.grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(230px,1fr));
  gap: 18px;
}

.box {
  background: rgba(255,255,255,0.65);
  padding: 16px;
  border-radius: 18px;
  transition: transform 0.25s ease, box-shadow 0.25s ease;
}

.box:hover {
  transform: translateY(-4px);
  box-shadow: 0 20px 40px rgba(0,0,0,0.15);
}

body.dark .box {
  background: rgba(0,0,0,0.45);
}

label {
  font-size: 14px;
  font-weight: 600;
}

label i {
  color: var(--blue);
  margin-right: 6px;
}

input[type=number] {
  width: 100%;
  margin-top: 8px;
  padding: 11px;
  border-radius: 12px;
  border: none;
  outline: none;
  font-size: 15px;
}

/* ================= BUTTON ================= */
button {
  width: 100%;
  margin-top: 30px;
  padding: 16px;
  border-radius: 16px;
  border: none;
  background: linear-gradient(135deg, #34c759, #30d158);
  color: white;
  font-size: 17px;
  font-weight: 700;
  cursor: pointer;
  transition: transform 0.25s ease, box-shadow 0.25s ease;
}

button:hover {
  transform: scale(1.04);
  box-shadow: 0 20px 40px rgba(52,199,89,0.5);
}

/* ================= RESULT ================= */
.result {
  margin-top: 25px;
  padding: 16px;
  text-align: center;
  font-size: 17px;
  font-weight: 700;
  border-radius: 999px;
  animation: pulseGlow 1.2s infinite alternate;
}

.on {
  background: rgba(255,59,48,0.18);
  color: var(--red);
}

.off {
  background: rgba(52,199,89,0.18);
  color: var(--green);
}

@keyframes pulseGlow {
  from { transform: scale(1); }
  to { transform: scale(1.06); }
}

/* ================= CHARTS ================= */
canvas {
  margin-top: 35px;
  background: rgba(255,255,255,0.6);
  border-radius: 22px;
  padding: 12px;
  animation: fadeIn 1s ease;
}

body.dark canvas {
  background: rgba(0,0,0,0.5);
}

@keyframes fadeIn {
  from { opacity: 0; }
  to { opacity: 1; }
}

/* ================= TABLE ================= */
table {
  width: 100%;
  border-collapse: collapse;
  margin-top: 30px;
  font-size: 13px;
  background: rgba(255,255,255,0.6);
  border-radius: 18px;
  overflow: hidden;
}

body.dark table {
  background: rgba(0,0,0,0.5);
}

th, td {
  padding: 10px;
  text-align: center;
}

th {
  background: rgba(0,0,0,0.06);
  font-weight: 700;
}

footer {
  text-align: center;
  margin-top: 25px;
  font-size: 12px;
  opacity: 0.75;
}
</style>
</head>

<body>
<div class="container">

  <h1>üå± Smart Irrigation System</h1>
  <p class="subtitle">
    AI-powered irrigation decision platform<br>
    <small>‚è∞ Time = hour of the day (0‚Äì23)</small>
  </p>

  <!-- Dark mode toggle -->
  <div class="toggle">
    <label class="switch">
      <input type="checkbox" id="darkToggle">
      <span class="slider"></span>
    </label>
  </div>

  <!-- FORM -->
  <form method="POST">
    <div class="grid">
      <div class="box">
        <label><i class="fa-solid fa-droplet"></i>Soil Moisture (%)</label>
        <input type="number" step="0.1" name="moisture" required>
      </div>
      <div class="box">
        <label><i class="fa-solid fa-temperature-half"></i>Temperature (¬∞C)</label>
        <input type="number" step="0.1" name="temp" required>
      </div>
      <div class="box">
        <label><i class="fa-solid fa-cloud"></i>Humidity (%)</label>
        <input type="number" step="0.1" name="humidity" required>
      </div>
      <div class="box">
        <label><i class="fa-solid fa-clock"></i>Time of Day (0‚Äì23)</label>
        <input type="number" min="0" max="23" name="time_of_day" required>
      </div>
    </div>

    <button type="submit">
      <i class="fa-solid fa-leaf"></i> Predict Irrigation
    </button>
  </form>

  {% if prediction %}
    <div class="result {{ 'on' if 'ON' in prediction else 'off' }}">
      {{ prediction }}
    </div>
  {% endif %}

  {% if history %}
    <h3>üìâ Moisture vs Pump Decision</h3>
    <canvas id="moistureChart"></canvas>

    <h3>üìâ Humidity vs Pump Decision</h3>
    <canvas id="humidityChart"></canvas>

    <h3>üìú Prediction History</h3>
    <table>
      <tr>
        <th>Time</th>
        <th>Moisture</th>
        <th>Temp</th>
        <th>Humidity</th>
        <th>Hour</th>
        <th>Decision</th>
      </tr>
      {% for row in history %}
      <tr>
        <td>{{ row.time }}</td>
        <td>{{ row.moisture }}</td>
        <td>{{ row.temp }}</td>
        <td>{{ row.humidity }}</td>
        <td>{{ row.hour }}</td>
        <td>{{ row.decision }}</td>
      </tr>
      {% endfor %}
    </table>
  {% endif %}

  <footer>
    Save Water
  </footer>
</div>

<script>
/* ================= DARK MODE (KEEP) ================= */
const toggle = document.getElementById("darkToggle");
if (localStorage.getItem("dark") === "true") {
  document.body.classList.add("dark");
  toggle.checked = true;
}
toggle.addEventListener("change", () => {
  document.body.classList.toggle("dark");
  localStorage.setItem("dark", document.body.classList.contains("dark"));
});

/* ================= DATA ================= */
const historyData = {{ history | tojson }};

/* Convert history to scatter points */
function scatterPoints(field) {
  return historyData.map(h => ({
    x: h[field],
    y: h.decision.includes("ON") ? 1 : 0,
    meta: h
  }));
}

/* ================= DECISION BOUNDARY ================= */
function decisionBoundary(threshold = 22) {
  return [
    { x: 0, y: 0.5 },
    { x: threshold, y: 0.5 },
    { x: threshold, y: 1 }
  ];
}

/* ================= COMMON OPTIONS ================= */
const commonOptions = {
  responsive: true,
  animation: {
    duration: 1600,
    easing: "easeOutQuart"
  },
  scales: {
    y: {
      min: 0,
      max: 1,
      ticks: {
        stepSize: 1,
        callback: v => v === 1 ? "ON" : "OFF"
      }
    }
  },
  plugins: {
    tooltip: {
      callbacks: {
        label: ctx => {
          const d = ctx.raw.meta;
          return [
            `Decision: ${d.decision}`,
            `Moisture: ${d.moisture}`,
            `Humidity: ${d.humidity}`,
            `Temp: ${d.temp}`,
            `Hour: ${d.hour}`
          ];
        }
      }
    },
    zoom: {
      zoom: {
        wheel: { enabled: true },
        pinch: { enabled: true },
        mode: "xy"
      },
      pan: {
        enabled: true,
        mode: "xy"
      }
    }
  }
};

/* ================= DRAW SCATTER ================= */
let moistureChart, humidityChart;

function drawChart(canvasId, field, color) {
  return new Chart(document.getElementById(canvasId), {
    type: "scatter",
    data: {
      datasets: [
        {
          label: field + " vs Decision",
          data: scatterPoints(field),
          backgroundColor: color,
          radius: 4,
          hoverRadius: 7
        },
        {
          label: "Decision Boundary",
          type: "line",
          data: decisionBoundary(),
          borderColor: "#ff9500",
          borderWidth: 2,
          pointRadius: 0,
          fill: false
        }
      ]
    },
    options: commonOptions
  });
}

/* ================= INITIAL DRAW ================= */
if (historyData.length > 0) {
  moistureChart = drawChart("moistureChart", "moisture", "#007aff");
  humidityChart = drawChart("humidityChart", "humidity", "#34c759");
}

/* ================= REDRAW ON NEW DATA ================= */
function redrawCharts() {
  if (moistureChart) moistureChart.destroy();
  if (humidityChart) humidityChart.destroy();

  moistureChart = drawChart("moistureChart", "moisture", "#007aff");
  humidityChart = drawChart("humidityChart", "humidity", "#34c759");
}

/* Auto-redraw if new prediction added */
window.addEventListener("load", redrawCharts);
</script>
</body>
</html>